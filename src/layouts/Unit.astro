---
import type { ISbStoryData } from "storyblok-js-client";
import BaseLayout from "@layouts/BaseLayout.astro";

// Components
import { Header } from "@src/components/Organisms/Core/Header/Header";
import { Unit as UnitComponent } from "@src/components/Organisms/Unit/Unit/Unit";

// Helpers
import { buildBreadcrumbs } from "@src/helpers/buildBreadcrumbs";
import { getSearchableChapters } from '@src/helpers/extractStoryblokPageContent';

interface Props {
  story: ISbStoryData;
}
const { story } = Astro.props;

// Indexes Unit contents (learning resources) according to chapters
const indexedChapterContent = getSearchableChapters(story);

const breadcrumbs = await buildBreadcrumbs(story.full_slug);

// Simple slugify for generating chapter links
const slugify = (text: string) => {
  return text
    .toString()
    .toLowerCase()
    .trim()
    .replace(/\s+/g, '-')
    .replace(/[^\w\-]+/g, '')
    .replace(/\-\-+/g, '-');
};
---

<BaseLayout title={story.name}>
  <main>
    <Header title={story.name} breadcrumbs={breadcrumbs} />
    
    <div data-pagefind-ignore>
      <UnitComponent story={story} client:visible />
    </div>

    <!-- GHOST CONTENT INDEX -->
    <div class="pf-ghost-wrapper">
      
      <!-- Main Page Title -->
      <div class="pf-ghost-chapter">
        <h1>{story.name}</h1>
      </div>

      {indexedChapterContent.map((chapter: any) => {
        // Create the ID for url linking from search: "How does RAP..." -> "how-does-rap..."
        const chapterId = slugify(chapter.title);
        
        return (
          <div class="pf-ghost-chapter">
            <!-- 
               1. ID: Allows Pagefind to link to individual chapters (e.g., #how-does-rap)
            -->
            <h2 id={chapterId}>
              {chapter.title}
            </h2>
            <p>{chapter.text}</p>
          </div>
        );
      })}
    </div>

  </main>
</BaseLayout>

<style>
  /* DEBUG CSS: Red box to verify content exists */
  /* .pf-ghost-wrapper {
    display: block; 
    background: #ffcccc;
    border: 5px solid red;
    padding: 20px;
    color: black;
    z-index: 9999;
    position: relative;
    margin: 20px;
  } */

  /* PRODUCTION CSS: Uncomment when ready */
  .pf-ghost-wrapper {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
    top: 0;
      left: 0;
  }
</style>